name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–¥—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
        uses: actions/checkout@v4

      - name: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan 38.242.214.198 >> ~/.ssh/known_hosts

      - name: –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±
        run: |
          ssh root@38.242.214.198 << 'EOF'
            export NVM_DIR=~/.nvm;
            source ~/.nvm/nvm.sh;
            export PATH=/root/.nvm/versions/node/v20.18.1/bin:$PATH;
            
            echo "üöÄ –ü–æ—á–∏–Ω–∞—î–º–æ –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
            cd /var/www/shina-mix-landing/back

            echo "üì• –û–Ω–æ–≤–ª—é—î–º–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π..."
            git fetch --all
            git reset --hard origin/main
            git clean -X --exclude=".env"
            git pull origin main
            
            echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ..."
            npm install
            
            echo "‚öôÔ∏è –ë—É–¥—É—î–º–æ Strapi..."
            npm run build

            echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ Strapi..."
            pm2 restart strapi
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
          EOF